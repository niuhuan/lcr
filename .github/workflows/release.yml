name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.32.8'

jobs:
  get-version:
    name: Get Version and Create Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}
      tag: ${{ steps.version.outputs.tag }}
      tag-created: ${{ steps.tag.outputs.created }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          TAG="v${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build-number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Build Number: ${BUILD_NUMBER}"
          echo "Tag: ${TAG}"
      
      - name: Create tag if not exists
        id: tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          
          # Check if tag exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "created=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists"
          else
            # Create and push tag
            git tag "$TAG"
            git push origin "$TAG"
            echo "created=true" >> $GITHUB_OUTPUT
            echo "Created and pushed tag $TAG"
          fi

  check-release:
    name: Check Release
    runs-on: ubuntu-latest
    needs: get-version
    outputs:
      release-exists: ${{ steps.check.outputs.exists }}
      existing-assets: ${{ steps.check.outputs.assets }}
    steps:
      - name: Check if release exists
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          
          # Check if release exists
          if gh release view "$TAG" &>/dev/null; then
            ASSETS=$(gh release view "$TAG" --json assets --jq -r '.assets[].name' 2>/dev/null | tr '\n' '|' || echo "")
            if [ -n "$ASSETS" ] && [ "$ASSETS" != "|" ]; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "assets=${ASSETS}" >> $GITHUB_OUTPUT
              echo "Release exists with assets:"
              echo "$ASSETS" | tr '|' '\n'
            else
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "assets=" >> $GITHUB_OUTPUT
              echo "Release exists but has no assets"
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "assets=" >> $GITHUB_OUTPUT
            echo "Release does not exist"
          fi

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [get-version, check-release]
    if: needs.check-release.outputs.release-exists == 'false'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          gh release create "$TAG" \
            --title "Release $VERSION" \
            --notes "Release $VERSION" \
            --draft \
            --prerelease=false || true

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [get-version, check-release]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if Android assets exist
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "app-release.apk" && \
             echo "$ASSETS" | grep -q "app-release.aab"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Android assets already exist, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Android assets missing, will build"
          fi
      
      - name: Setup Java
        if: steps.check-assets.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Accept Android licenses
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter doctor --android-licenses || true
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Setup Android signing
        if: steps.check-assets.outputs.skip != 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          # Create keystore directory
          mkdir -p android/app
          
          # Check if keystore secret is provided
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "Error: ANDROID_KEYSTORE_BASE64 secret is not set"
            exit 1
          fi
          
          # Decode base64 keystore from secret and write to file
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/keystore.jks
          
          # Verify keystore file was created and is valid
          if [ ! -f android/app/keystore.jks ]; then
            echo "Error: Keystore file was not created"
            exit 1
          fi
          
          # Check file size (should be > 0)
          if [ ! -s android/app/keystore.jks ]; then
            echo "Error: Keystore file is empty"
            exit 1
          fi
          
          echo "Keystore file created successfully"
          ls -lh android/app/keystore.jks
          
          # Create key.properties file with correct path
          cat > android/key.properties <<EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=app/keystore.jks
          EOF
          
          echo "Key properties file created"
      
      - name: Configure Android signing
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          # Read the current build.gradle.kts
          cat android/app/build.gradle.kts > android/app/build.gradle.kts.bak
          
          # Create a new build.gradle.kts with signing config
          cat > android/app/build.gradle.kts <<'EOF'
          plugins {
              id("com.android.application")
              id("kotlin-android")
              id("dev.flutter.flutter-gradle-plugin")
          }

          // Load keystore properties
          val keystorePropertiesFile = rootProject.file("key.properties")
          val keystoreProperties = java.util.Properties()
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(java.io.FileInputStream(keystorePropertiesFile))
          }

          android {
              namespace = "opensource.lcr"
              compileSdk = flutter.compileSdkVersion
              ndkVersion = flutter.ndkVersion

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_11
                  targetCompatibility = JavaVersion.VERSION_11
              }

              kotlinOptions {
                  jvmTarget = JavaVersion.VERSION_11.toString()
              }

              defaultConfig {
                  applicationId = "opensource.lcr"
                  minSdk = flutter.minSdkVersion
                  targetSdk = flutter.targetSdkVersion
                  versionCode = flutter.versionCode
                  versionName = flutter.versionName
              }

              signingConfigs {
                  create("release") {
                      keyAlias = keystoreProperties["keyAlias"] as String
                      keyPassword = keystoreProperties["keyPassword"] as String
                      storeFile = file(keystoreProperties["storeFile"] as String)
                      storePassword = keystoreProperties["storePassword"] as String
                  }
              }

              buildTypes {
                  release {
                      signingConfig = signingConfigs.getByName("release")
                  }
              }
          }

          flutter {
              source = "../.."
          }
          EOF
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build APK
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build apk --release \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Build App Bundle
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build appbundle --release \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Upload Android artifacts
        if: steps.check-assets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          retention-days: 1

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: [get-version, check-release]
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if Linux asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ASSET_NAME="lcr-${VERSION}-linux-aarch64.AppImage"
          else
            ASSET_NAME="lcr-${VERSION}-linux-x86_64.AppImage"
          fi
          
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "$ASSET_NAME"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Linux ${{ matrix.arch }} asset already exists, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Linux ${{ matrix.arch }} asset missing, will build"
          fi
      
      - name: Install Linux dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libgl1-mesa-dev xorg-dev libfuse2
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build Linux
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            flutter build linux --release \
              --build-name=${{ needs.get-version.outputs.version }} \
              --build-number=${{ needs.get-version.outputs.build-number }} \
              --target-platform=linux-arm64
          else
            flutter build linux --release \
              --build-name=${{ needs.get-version.outputs.version }} \
              --build-number=${{ needs.get-version.outputs.build-number }} \
              --target-platform=linux-x64
          fi
      
      - name: Create AppImage
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          # Determine architecture for appimagetool
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ARCH="aarch64"
            APPIMAGE_TOOL="appimagetool-aarch64.AppImage"
          else
            ARCH="x86_64"
            APPIMAGE_TOOL="appimagetool-x86_64.AppImage"
          fi
          
          # Download appimagetool
          wget https://github.com/AppImage/appimagetool/releases/download/continuous/$APPIMAGE_TOOL
          chmod +x $APPIMAGE_TOOL
          
          # Prepare bundle directory
          BUNDLE_DIR="build/linux/${{ matrix.arch }}/release/bundle"
          
          # Rename executable to AppRun
          if [ -f "$BUNDLE_DIR/lcr" ]; then
            mv "$BUNDLE_DIR/lcr" "$BUNDLE_DIR/AppRun"
          fi
          
          # Copy AppImage files (.desktop and icon)
          if [ -f "linux/appimage/lcr.desktop" ]; then
            cp linux/appimage/lcr.desktop "$BUNDLE_DIR/"
          fi
          if [ -f "linux/appimage/lcr.png" ]; then
            mkdir -p "$BUNDLE_DIR/usr/share/icons/hicolor/512x512/apps"
            cp linux/appimage/lcr.png "$BUNDLE_DIR/usr/share/icons/hicolor/512x512/apps/"
          fi
          
          # Create AppImage
          ./$APPIMAGE_TOOL "$BUNDLE_DIR"
          
          # Rename to versioned filename
          VERSION="${{ needs.get-version.outputs.version }}"
          # AppImage tool creates file based on .desktop Name field
          # Find the created AppImage file and rename it
          APPIMAGE_FILE=$(ls -1 *.AppImage 2>/dev/null | head -n 1)
          if [ -n "$APPIMAGE_FILE" ]; then
            if [ "$ARCH" = "aarch64" ]; then
              mv "$APPIMAGE_FILE" "lcr-${VERSION}-linux-aarch64.AppImage"
            else
              mv "$APPIMAGE_FILE" "lcr-${VERSION}-linux-x86_64.AppImage"
            fi
            echo "AppImage created: lcr-${VERSION}-linux-${ARCH}.AppImage"
            ls -lh lcr-${VERSION}-linux-${ARCH}.AppImage
          else
            echo "Error: AppImage file not found"
            ls -la
            exit 1
          fi
      
      - name: Upload Linux artifacts
        if: steps.check-assets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: lcr-${{ needs.get-version.outputs.version }}-linux-${{ matrix.arch == 'arm64' && 'aarch64' || 'x86_64' }}.AppImage
          retention-days: 1

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [get-version, check-release]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if Windows asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $TAG = "${{ needs.get-version.outputs.tag }}"
          $ASSETS = "${{ needs.check-release.outputs.existing-assets }}"
          $ASSET_NAME = "lcr-windows-x64.zip"
          
          if (("${{ needs.check-release.outputs.release-exists }}" -eq "true") -and ($ASSETS -match $ASSET_NAME)) {
            Write-Host "Windows asset already exists, skipping build"
            echo "skip=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Windows asset missing, will build"
            echo "skip=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build Windows
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build windows --release `
            --build-name=${{ needs.get-version.outputs.version }} `
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Create archive
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath lcr-windows-x64.zip -Force
      
      - name: Upload Windows artifacts
        if: steps.check-assets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: lcr-windows-x64.zip
          retention-days: 1

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: [get-version, check-release]
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if macOS asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          ASSET_NAME="lcr-macos-${{ matrix.arch }}.dmg"
          
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "$ASSET_NAME"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "macOS ${{ matrix.arch }} asset already exists, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "macOS ${{ matrix.arch }} asset missing, will build"
          fi
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build macOS
        if: steps.check-assets.outputs.skip != 'true'
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          if [ "$ARCH" = "arm64" ]; then
            flutter build macos --release \
              --build-name=${{ needs.get-version.outputs.version }} \
              --build-number=${{ needs.get-version.outputs.build-number }} \
              --target-platform=darwin-arm64
          else
            flutter build macos --release \
              --build-name=${{ needs.get-version.outputs.version }} \
              --build-number=${{ needs.get-version.outputs.build-number }} \
              --target-platform=darwin-x64
          fi
      
      - name: Create DMG
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          cd build
          mkdir -p dmg
          mv macos/Build/Products/Release/lcr.app dmg/
          ln -sf /Applications dmg/
          hdiutil create -volname lcr -srcfolder dmg -ov -format UDBZ lcr-macos-${{ matrix.arch }}.dmg
          mv lcr-macos-${{ matrix.arch }}.dmg ../
          cd ..
      
      - name: Upload macOS artifacts
        if: steps.check-assets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: lcr-macos-${{ matrix.arch }}.dmg
          retention-days: 1

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: [get-version, check-release]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if iOS asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "\.ipa"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "iOS asset already exists, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "iOS asset missing, will build"
          fi
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build iOS
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build ipa --release \
            --no-codesign \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Package IPA from xcarchive
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          # Create Payload directory
          mkdir -p Payload
          
          # Copy .app from xcarchive to Payload
          APP_NAME=$(ls build/ios/archive/Runner.xcarchive/Products/Applications/ | grep .app)
          cp -r "build/ios/archive/Runner.xcarchive/Products/Applications/$APP_NAME" Payload/
          
          # Create IPA file using zip
          zip -r lcr.ipa Payload
          
          # Clean up
          rm -rf Payload
          
          echo "IPA file created: lcr.ipa"
          ls -lh lcr.ipa
      
      - name: Upload iOS artifacts
        if: steps.check-assets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: lcr.ipa
          retention-days: 1

  upload-release:
    name: Upload to Release
    runs-on: ubuntu-latest
    needs: [get-version, check-release, create-release, build-android, build-linux, build-windows, build-macos, build-ios]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: '*'
          merge-multiple: false
      
      - name: Upload to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          
          # Ensure release exists
          if ! gh release view "$TAG" &>/dev/null; then
            VERSION="${{ needs.get-version.outputs.version }}"
            gh release create "$TAG" \
              --title "Release $VERSION" \
              --notes "Release $VERSION" \
              --draft || true
          fi
          
          # Find and upload all artifact files
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.zip" -o -name "*.tar.gz" -o -name "*.ipa" -o -name "*.dmg" -o -name "*.AppImage" \) | while read file; do
            filename=$(basename "$file")
            echo "Uploading $filename..."
            gh release upload "$TAG" "$file" --clobber || echo "Warning: Failed to upload $filename"
          done
          
          # Publish the release if it was a draft
          gh release edit "$TAG" --draft=false || true
