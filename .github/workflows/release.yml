name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.32.8'

jobs:
  get-version:
    name: Get Version and Create Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}
      tag: ${{ steps.version.outputs.tag }}
      tag-created: ${{ steps.tag.outputs.created }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          TAG="v${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build-number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Build Number: ${BUILD_NUMBER}"
          echo "Tag: ${TAG}"
      
      - name: Create tag if not exists
        id: tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          
          # Check if tag exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "created=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists"
          else
            # Create and push tag
            git tag "$TAG"
            git push origin "$TAG"
            echo "created=true" >> $GITHUB_OUTPUT
            echo "Created and pushed tag $TAG"
          fi

  check-release:
    name: Check Release
    runs-on: ubuntu-latest
    needs: get-version
    outputs:
      release-exists: ${{ steps.check.outputs.exists }}
      existing-assets: ${{ steps.check.outputs.assets }}
    steps:
      - name: Check if release exists
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          
          # Check if release exists
          if gh release view "$TAG" &>/dev/null; then
            ASSETS=$(gh release view "$TAG" --json assets --jq -r '.assets[].name' 2>/dev/null | tr '\n' '|' || echo "")
            if [ -n "$ASSETS" ] && [ "$ASSETS" != "|" ]; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "assets=${ASSETS}" >> $GITHUB_OUTPUT
              echo "Release exists with assets:"
              echo "$ASSETS" | tr '|' '\n'
            else
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "assets=" >> $GITHUB_OUTPUT
              echo "Release exists but has no assets"
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "assets=" >> $GITHUB_OUTPUT
            echo "Release does not exist"
          fi

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [get-version, check-release]
    if: needs.check-release.outputs.release-exists == 'false'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          gh release create "$TAG" \
            --title "Release $VERSION" \
            --notes "Release $VERSION" \
            --draft \
            --prerelease=false || true

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [get-version, check-release]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if Android assets exist
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          
          VERSION="${{ needs.get-version.outputs.version }}"
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "lcr-${VERSION}-android.apk" && \
             echo "$ASSETS" | grep -q "lcr-${VERSION}-android.aab"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Android assets already exist, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Android assets missing, will build"
          fi
      
      - name: Setup Java
        if: steps.check-assets.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Accept Android licenses
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          yes | flutter doctor --android-licenses || true
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build APK
        if: steps.check-assets.outputs.skip != 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          flutter build apk --release \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
          echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
          echo $KEY_PASSWORD | $ANDROID_HOME/build-tools/34.0.0/apksigner sign --ks keystore.jks build/app/outputs/flutter-apk/app-release.apk

      - name: Build App Bundle
        if: steps.check-assets.outputs.skip != 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          flutter build appbundle --release \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Setup GitHub CLI
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || gh auth login --with-token <<< "$GITHUB_TOKEN"
      
      - name: Ensure Release Exists
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          if ! gh release view "$TAG" &>/dev/null; then
            VERSION="${{ needs.get-version.outputs.version }}"
            gh release create "$TAG" \
              --title "Release $VERSION" \
              --notes "Release $VERSION" \
              --draft || true
          fi
      
      - name: Upload Android to Release
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          
          # Rename and upload APK
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            APK_NAME="lcr-${VERSION}-android.apk"
            cp "build/app/outputs/flutter-apk/app-release.apk" "$APK_NAME"
            echo "Uploading $APK_NAME..."
            gh release upload "$TAG" "$APK_NAME" --clobber
            echo "✓ APK uploaded successfully"
            rm -f "$APK_NAME"
          fi
          
          # Rename and upload AAB
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            AAB_NAME="lcr-${VERSION}-android.aab"
            cp "build/app/outputs/bundle/release/app-release.aab" "$AAB_NAME"
            echo "Uploading $AAB_NAME..."
            gh release upload "$TAG" "$AAB_NAME" --clobber
            echo "✓ AAB uploaded successfully"
            rm -f "$AAB_NAME"
          fi

  build-linux:
    name: Build Linux
    needs: [get-version, check-release]
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-24.04
            target_arch: x86_64
          - arch: arm64
            runner: ubuntu-24.04-arm
            target_arch: aarch64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if Linux asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          
          if [ "${{ matrix.target_arch }}" = "aarch64" ]; then
            ASSET_NAME="lcr-${VERSION}-linux-aarch64.AppImage"
          else
            ASSET_NAME="lcr-${VERSION}-linux-x86_64.AppImage"
          fi
          
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "$ASSET_NAME"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Linux ${{ matrix.target_arch }} asset already exists, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Linux ${{ matrix.target_arch }} asset missing, will build"
          fi
      
      - name: Install Linux dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libgl1-mesa-dev xorg-dev libfuse2
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build Linux
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build linux --release \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Create AppImage
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          # Determine architecture for appimagetool
          ARCH="${{ matrix.target_arch }}"
          if [ "$ARCH" = "aarch64" ]; then
            APPIMAGE_TOOL="appimagetool-aarch64.AppImage"
          else
            APPIMAGE_TOOL="appimagetool-x86_64.AppImage"
          fi
          
          # Download appimagetool
          wget https://github.com/AppImage/appimagetool/releases/download/continuous/$APPIMAGE_TOOL
          chmod +x $APPIMAGE_TOOL
          
          # Prepare bundle directory
          BUNDLE_DIR="build/linux/${{ matrix.target_arch }}/release/bundle"
          
          # Rename executable to AppRun
          if [ -f "$BUNDLE_DIR/lcr" ]; then
            mv "$BUNDLE_DIR/lcr" "$BUNDLE_DIR/AppRun"
          fi
          
          # Copy AppImage files (.desktop and icon)
          if [ -f "linux/appimage/lcr.desktop" ]; then
            cp linux/appimage/lcr.desktop "$BUNDLE_DIR/"
          fi
          if [ -f "linux/appimage/lcr.png" ]; then
            mkdir -p "$BUNDLE_DIR/usr/share/icons/hicolor/512x512/apps"
            cp linux/appimage/lcr.png "$BUNDLE_DIR/usr/share/icons/hicolor/512x512/apps/"
          fi
          
          # Create AppImage
          ./$APPIMAGE_TOOL "$BUNDLE_DIR"
          
          # Rename to versioned filename
          VERSION="${{ needs.get-version.outputs.version }}"
          # AppImage tool creates file based on .desktop Name field
          # Find the created AppImage file and rename it
          APPIMAGE_FILE=$(ls -1 *.AppImage 2>/dev/null | head -n 1)
          if [ -n "$APPIMAGE_FILE" ]; then
            if [ "$ARCH" = "aarch64" ]; then
              mv "$APPIMAGE_FILE" "lcr-${VERSION}-linux-aarch64.AppImage"
            else
              mv "$APPIMAGE_FILE" "lcr-${VERSION}-linux-x86_64.AppImage"
            fi
            echo "AppImage created: lcr-${VERSION}-linux-${ARCH}.AppImage"
            ls -lh lcr-${VERSION}-linux-${ARCH}.AppImage
          else
            echo "Error: AppImage file not found"
            ls -la
            exit 1
          fi
      
      - name: Setup GitHub CLI
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || gh auth login --with-token <<< "$GITHUB_TOKEN"
      
      - name: Ensure Release Exists
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          if ! gh release view "$TAG" &>/dev/null; then
            VERSION="${{ needs.get-version.outputs.version }}"
            gh release create "$TAG" \
              --title "Release $VERSION" \
              --notes "Release $VERSION" \
              --draft || true
          fi
      
      - name: Upload Linux to Release
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          APPIMAGE_FILE="lcr-${{ needs.get-version.outputs.version }}-linux-${{ matrix.target_arch }}.AppImage"
          
          if [ -f "$APPIMAGE_FILE" ]; then
            echo "Uploading $APPIMAGE_FILE..."
            gh release upload "$TAG" "$APPIMAGE_FILE" --clobber
            echo "✓ Linux AppImage uploaded successfully"
          else
            echo "Error: $APPIMAGE_FILE not found"
            exit 1
          fi

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [get-version, check-release]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if Windows asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $TAG = "${{ needs.get-version.outputs.tag }}"
          $ASSETS = "${{ needs.check-release.outputs.existing-assets }}"
          $VERSION = "${{ needs.get-version.outputs.version }}"
          $ASSET_NAME = "lcr-${VERSION}-windows-x64.zip"
          
          if (("${{ needs.check-release.outputs.release-exists }}" -eq "true") -and ($ASSETS -match $ASSET_NAME)) {
            Write-Host "Windows asset already exists, skipping build"
            echo "skip=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Windows asset missing, will build"
            echo "skip=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build Windows
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build windows --release `
            --build-name=${{ needs.get-version.outputs.version }} `
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Create archive
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          $VERSION = "${{ needs.get-version.outputs.version }}"
          $ZIP_NAME = "lcr-${VERSION}-windows-x64.zip"
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath $ZIP_NAME -Force
      
      - name: Setup GitHub CLI
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $env:GH_TOKEN = $env:GITHUB_TOKEN
          gh auth status
          if ($LASTEXITCODE -ne 0) {
            echo $env:GITHUB_TOKEN | gh auth login --with-token
          }
      
      - name: Ensure Release Exists
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $TAG = "${{ needs.get-version.outputs.tag }}"
          if (-not (gh release view $TAG 2>$null)) {
            $VERSION = "${{ needs.get-version.outputs.version }}"
            gh release create $TAG `
              --title "Release $VERSION" `
              --notes "Release $VERSION" `
              --draft
          }
      
      - name: Upload Windows to Release
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $TAG = "${{ needs.get-version.outputs.tag }}"
          $VERSION = "${{ needs.get-version.outputs.version }}"
          $ZIP_FILE = "lcr-${VERSION}-windows-x64.zip"
          
          if (Test-Path $ZIP_FILE) {
            Write-Host "Uploading $ZIP_FILE..."
            gh release upload $TAG $ZIP_FILE --clobber
            Write-Host "✓ Windows ZIP uploaded successfully"
          } else {
            Write-Host "Error: $ZIP_FILE not found"
            exit 1
          }

  build-macos:
    name: Build macOS
    needs: [get-version, check-release]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if macOS asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          ASSET_NAME="lcr-${{ needs.get-version.outputs.version }}-macos.dmg"
          
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "$ASSET_NAME"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "macOS asset already exists, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "macOS asset missing, will build"
          fi
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build macOS
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build macos --release \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Create DMG
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          DMG_NAME="lcr-${VERSION}-macos.dmg"
          
          mkdir -p macos_bundle
          ln -sf /Applications macos_bundle/
          mv build/macos/Build/Products/Release/lcr.app macos_bundle/
          hdiutil create -volname lcr -srcfolder macos_bundle -ov -format UDBZ "$DMG_NAME"
          rm -rf macos_bundle
      
      - name: Setup GitHub CLI
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || gh auth login --with-token <<< "$GITHUB_TOKEN"
      
      - name: Ensure Release Exists
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          if ! gh release view "$TAG" &>/dev/null; then
            VERSION="${{ needs.get-version.outputs.version }}"
            gh release create "$TAG" \
              --title "Release $VERSION" \
              --notes "Release $VERSION" \
              --draft || true
          fi
      
      - name: Upload macOS to Release
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          DMG_FILE="lcr-${{ needs.get-version.outputs.version }}-macos.dmg"
          
          if [ -f "$DMG_FILE" ]; then
            echo "Uploading $DMG_FILE..."
            gh release upload "$TAG" "$DMG_FILE" --clobber
            echo "✓ macOS DMG uploaded successfully"
          else
            echo "Error: $DMG_FILE not found"
            exit 1
          fi

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: [get-version, check-release]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if iOS asset exists
        id: check-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          ASSETS="${{ needs.check-release.outputs.existing-assets }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          ASSET_NAME="lcr-${VERSION}-ios.ipa"
          
          if [ "${{ needs.check-release.outputs.release-exists }}" = "true" ] && \
             echo "$ASSETS" | grep -q "$ASSET_NAME"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "iOS asset already exists, skipping build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "iOS asset missing, will build"
          fi
      
      - name: Setup Flutter
        if: steps.check-assets.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Install Rust
        if: steps.check-assets.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        if: steps.check-assets.outputs.skip != 'true'
        run: flutter pub get
      
      - name: Build iOS
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          flutter build ipa --release \
            --no-codesign \
            --build-name=${{ needs.get-version.outputs.version }} \
            --build-number=${{ needs.get-version.outputs.build-number }}
      
      - name: Package IPA from xcarchive
        if: steps.check-assets.outputs.skip != 'true'
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          IPA_NAME="lcr-${VERSION}-ios.ipa"
          
          # Create Payload directory
          mkdir -p Payload
          
          # Copy .app from xcarchive to Payload
          APP_NAME=$(ls build/ios/archive/Runner.xcarchive/Products/Applications/ | grep .app)
          cp -r "build/ios/archive/Runner.xcarchive/Products/Applications/$APP_NAME" Payload/
          
          # Create IPA file using zip with versioned name
          zip -r "$IPA_NAME" Payload
          
          # Clean up
          rm -rf Payload
          
          echo "IPA file created: $IPA_NAME"
          ls -lh "$IPA_NAME"
      
      - name: Setup GitHub CLI
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || gh auth login --with-token <<< "$GITHUB_TOKEN"
      
      - name: Ensure Release Exists
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          if ! gh release view "$TAG" &>/dev/null; then
            VERSION="${{ needs.get-version.outputs.version }}"
            gh release create "$TAG" \
              --title "Release $VERSION" \
              --notes "Release $VERSION" \
              --draft || true
          fi
      
      - name: Upload iOS to Release
        if: steps.check-assets.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          IPA_NAME="lcr-${VERSION}-ios.ipa"
          
          if [ -f "$IPA_NAME" ]; then
            echo "Uploading $IPA_NAME..."
            gh release upload "$TAG" "$IPA_NAME" --clobber
            echo "✓ iOS IPA uploaded successfully"
          else
            echo "Error: $IPA_NAME not found"
            exit 1
          fi

  verify-and-publish-release:
    name: Verify and Publish Release
    runs-on: ubuntu-latest
    needs: [get-version, check-release, create-release, build-android, build-linux, build-windows, build-macos, build-ios]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || gh auth login --with-token <<< "$GITHUB_TOKEN"
      
      - name: Verify Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          VERSION="${{ needs.get-version.outputs.version }}"
          
          echo "=== Verifying Release Assets ==="
          
          # Check if release exists
          if ! gh release view "$TAG" &>/dev/null; then
            echo "Error: Release $TAG does not exist"
            exit 1
          fi
          
          # Get all assets from release
          ASSETS=$(gh release view "$TAG" --json assets --jq -r '.assets[].name' 2>/dev/null || echo "")
          
          if [ -z "$ASSETS" ]; then
            echo "Warning: No assets found in release $TAG"
            echo "Release may be empty or assets failed to upload"
          else
            echo "Found assets in release:"
            echo "$ASSETS" | sed 's/^/  - /'
            echo ""
            
            # Expected assets
            EXPECTED_ASSETS=(
              "lcr-${VERSION}-android.apk"
              "lcr-${VERSION}-android.aab"
              "lcr-${VERSION}-linux-x86_64.AppImage"
              "lcr-${VERSION}-linux-aarch64.AppImage"
              "lcr-${VERSION}-windows-x64.zip"
              "lcr-${VERSION}-macos.dmg"
              "lcr-${VERSION}-ios.ipa"
            )
            
            echo "=== Checking Expected Assets ==="
            MISSING_ASSETS=()
            for expected in "${EXPECTED_ASSETS[@]}"; do
              if echo "$ASSETS" | grep -qF "$expected"; then
                echo "✓ Found: $expected"
              else
                echo "✗ Missing: $expected"
                MISSING_ASSETS+=("$expected")
              fi
            done
            
            if [ ${#MISSING_ASSETS[@]} -gt 0 ]; then
              echo ""
              echo "Warning: Some expected assets are missing:"
              printf '  - %s\n' "${MISSING_ASSETS[@]}"
              echo "This may be expected if some builds were skipped or failed"
            else
              echo ""
              echo "✓ All expected assets are present"
            fi
          fi
          
          echo ""
          echo "=== Release Status ==="
          RELEASE_INFO=$(gh release view "$TAG" --json isDraft,isPrerelease,publishedAt 2>/dev/null || echo "{}")
          IS_DRAFT=$(echo "$RELEASE_INFO" | jq -r '.isDraft // false')
          IS_PRERELEASE=$(echo "$RELEASE_INFO" | jq -r '.isPrerelease // false')
          PUBLISHED_AT=$(echo "$RELEASE_INFO" | jq -r '.publishedAt // "null"')
          
          echo "Release: $TAG"
          echo "Draft: $IS_DRAFT"
          echo "Prerelease: $IS_PRERELEASE"
          echo "Published: $PUBLISHED_AT"
      
      - name: Publish Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-version.outputs.tag }}"
          
          echo "=== Publishing Release ==="
          
          # Check if release is a draft
          IS_DRAFT=$(gh release view "$TAG" --json isDraft --jq '.isDraft' 2>/dev/null || echo "false")
          
          if [ "$IS_DRAFT" = "true" ]; then
            echo "Release is a draft, publishing now..."
            if gh release edit "$TAG" --draft=false 2>&1; then
              echo "✓ Release $TAG published successfully"
            else
              echo "✗ Failed to publish release $TAG"
              exit 1
            fi
          else
            echo "Release $TAG is already published"
          fi
          
          echo ""
          echo "=== Final Release Information ==="
          gh release view "$TAG" --json name,tagName,isDraft,isPrerelease,publishedAt,assets --jq '{
            name: .name,
            tag: .tagName,
            draft: .isDraft,
            prerelease: .isPrerelease,
            published: .publishedAt,
            asset_count: (.assets | length),
            assets: [.assets[] | .name]
          }' || true
